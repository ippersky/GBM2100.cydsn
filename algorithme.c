/* ========================================
 *
 * Copyright YOUR COMPANY, THE YEAR
 * All Rights Reserved
 * UNPUBLISHED, LICENSED SOFTWARE.
 *
 * CONFIDENTIAL AND PROPRIETARY INFORMATION
 * WHICH IS THE PROPERTY OF your company.
 *
 * ========================================
*/

#include <arm_math.h>
#include <core_cm4.h>
#include <params.h>

#define LONGUEUR_ECH 1000 // longueur totale des donnees
#define BLOCK_SIZE 200 // nombre d`echantillons processed par appel
#define SECONDES 5 // nombre de secondes sur lesquelles on fait le traitement
// total de 5 echantillons de longueur 200 = 5 secondes

// Cette fonction calcule la frequence cardiaque. Elle prend en parametre
// le buffer rouge (ou infrarouge) et retourne le BPM
uint32_t HeartRate(uint32_t *Signal, uint32_t temps1, uint32_t temps2){
    
    //Filtrage le signal avec un filtre passe-bas
    float32_t Input[LONGUEUR_ECH]; // initialiser le vecteur input
    uint32_t i, compteur=0;
    for (i=temps1; i<temps2; i++){
    Input[compteur]=Signal[i];   
    compteur++;
    }
    
    float32_t Output[LONGUEUR_ECH]; //initialiser le buffer output
        /*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 200 Hz

* 0 Hz - 2 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = 4.091565543452514 dB

* 2.5 Hz - 100 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -40.170809843362925 dB

*/

#define FILTER_TAP_NUM 405

static double filter_taps[FILTER_TAP_NUM] = {
  -0.00498550729671324, -0.0016203309422694644, -0.00040834948018148796,-0.0016935269804353057,
  -0.0006632119209307095,-0.0017877011074162047,-0.000913935305670097,-0.0018998108003590267,
  -0.0011605941656346712,-0.0020258369747564167,-0.0014021152433113494,-0.002162631303529877,
  -0.001637439035832092,-0.0023064584555358572,-0.0018650171818320094,-0.0024537591210338624,
  -0.0020833450535500194,-0.002601053277664898,-0.002290024978384548,-0.002744794016059322,
  -0.0024834315778976125,-0.0028816592820257534,-0.0026612234198504794,-0.0030084681861656673,
  -0.002820920769521245,-0.0031220027697236217,-0.002960247074711649,-0.003218933912951922,
  -0.0030767528678586555,-0.0032958406688973615,-0.0031678281969379192,-0.0033498582596491917,
  -0.003231205720108523,-0.0033784760357948836,-0.0032648745486325422,-0.003379454244089983,
  -0.0032675257384755137,-0.00335110057503356,-0.003238225942722612,-0.003292538143738589,
  -0.0031762025201501533,-0.003202836154744756,-0.0030808430122533214,-0.0030811510625117617,
  -0.002951853129932978,-0.002926934209610943,-0.002789125473848081,-0.0027403381509319975,
  -0.0025933837938034963,-0.002522807512727684,-0.0023669796819694596,-0.0022771047972569088,
  -0.0021131413095489297,-0.002005587866071696,-0.001834077842198626,-0.0017101734853428782,
  -0.0015305486297832371,-0.001391736337876226,-0.0012050377048797441,-0.0010546514579484422,
  -0.0008647414805497481,-0.0007074045988542337,-0.0005164948931739942,-0.0003522980668294563,
  -0.00015661183878642616,0.000014787263331467169,0.00020448681142760838,0.00036957543165597,
  0.0005604923947770094,0.0007297779862746035,0.0009070527793806994,0.0010700115388710902,
  0.0012449045593625118,0.0013950622427804185,0.0015589290893588147,0.0017011945124342928,
  0.001847602777115003, 0.0019789962774483727, 0.0021080490705978018, 0.0022225119656553035,
  0.002335089392892868,0.0024288131010452283,0.0025223787595859983,0.0025944563899648267,
  0.0026654886119140994,0.0027161972830158643,0.0027615963734293663,0.0027898262676349177,
  0.002808663394508168,0.002812425317126703,0.002804863087193834,0.0027823561500027834,
  0.0027486098719066137,0.0026985294764617215,0.002638674822409953, 0.0025610284211509274,
  0.0024750537944191863,0.0023710336414560053,0.002258778305502216,0.0021301024448355946,
  0.0019921823572090734,0.001840528831557174, 0.0016785915304533996, 0.0015053615156079877,
  0.0013218224201994612, 0.0011284868024924737, 0.0009259557442267539, 0.000714972249800228,
  0.0004966264817311014, 0.00027106553326555896, 0.00004062249781472064, -0.0001962915564054726,
  -0.00043522574411154036, -0.0006799799326299368, -0.0009241027030114334, -0.0011724081117273318,
  -0.0014179843735038604, -0.0016650052462718482, -0.0019075206217462758, -0.002148350824063294,
  -0.002383144481283403, -0.002613924611965202, -0.0028372697865244475, -0.003053434734731972,
  -0.003260710678185438, -0.0034570505575471544, -0.003642299368634417, -0.003814901380318594,
  -0.003974587693848104, -0.004120284706730435, -0.0042501708822830905, -0.004362469881297017,
  -0.00445728570525301, -0.004535599860922524, -0.004593409719455879, -0.0046305254577844995,
  -0.004646795124303667, -0.004643582680430925, -0.004615328423621958, -0.004565375032167611,
  -0.004492745938368636, -0.004395390469009092, -0.0042736612701465, -0.004127903275598136,
  -0.003957298110751697, -0.0037607847992965748, -0.0035413667222187603, -0.003293522182663502,
  -0.00302434623764893, -0.002727297966253142, -0.002408124537940546, -0.002062738336719401,
  -0.0016949594533060982, -0.0013022667152937273, -0.0008885699012301841, -0.0004505541799177027,
  0.000006502587645121508,  0.00048649116302927105, 0.0009845955558936584,  0.001502318764602335,
  0.0020377338532006264,  0.002589046160734021,  0.0031570669235161082,  0.003738033955281069,
  0.004333453051188177,  0.004939340129759301,  0.005556435373065934,  0.0061816440726056455,
  0.006814418286589923,  0.007452838881339023,  0.008095564444272266,  0.008740919004663174,
  0.009387650326911164,  0.010033403044885572,  0.010677600854204473,  0.011317238151125904,
  0.011951598121811811,  0.012578921578233138,  0.013196483551668858,  0.013805144243056134,  
  0.01439990614570019,0.014983063661478073,  0.015549199541573425,  0.01609997033778883,
  0.016631017297310514,  0.017143491692591856,  0.017633671181357505,  0.018102876840045638,
  0.018546858793028954,  0.018967271352802347,  0.019360251710905586,  0.019726497509944537,
  0.020064170327279075,  0.02037325197517535,  0.02065155159013744,  0.0208994919258975,
  0.0211152073385961,  0.021298588985660456,  0.02145084643328954,  0.021568252828088837,
  0.021652833112446524,  0.021703211564228893,  0.021721469265064193,  0.021703211564228893,
  0.021652833112446524,  0.021568252828088837,  0.02145084643328954,  0.021298588985660456,
  0.0211152073385961,  0.0208994919258975,  0.02065155159013744,  0.02037325197517535,
  0.020064170327279075,  0.019726497509944537,  0.019360251710905586,  0.018967271352802347,
  0.018546858793028954,  0.018102876840045638,  0.017633671181357505,  0.017143491692591856,
  0.016631017297310514,  0.01609997033778883,  0.015549199541573425,  0.014983063661478073,
  0.01439990614570019,  0.013805144243056134,  0.013196483551668858,  0.012578921578233138,
  0.011951598121811811,  0.011317238151125904,  0.010677600854204473,  0.010033403044885572,
  0.009387650326911164,  0.008740919004663174,  0.008095564444272266,  0.007452838881339023,
  0.006814418286589923, 0.0061816440726056455,  0.005556435373065934,  0.004939340129759301,
  0.004333453051188177,  0.003738033955281069,  0.0031570669235161082,  0.002589046160734021,
  0.0020377338532006264,  0.001502318764602335,  0.0009845955558936584,  0.00048649116302927105,
  0.000006502587645121508,  -0.0004505541799177027,  -0.0008885699012301841,  -0.0013022667152937273,
  -0.0016949594533060982,  -0.002062738336719401,  -0.002408124537940546,  -0.002727297966253142,
  -0.00302434623764893,  -0.003293522182663502,  -0.0035413667222187603,  -0.0037607847992965748,
  -0.003957298110751697,  -0.004127903275598136,  -0.0042736612701465,  -0.004395390469009092,
  -0.004492745938368636,  -0.004565375032167611,  -0.004615328423621958,  -0.004643582680430925,
  -0.004646795124303667, -0.0046305254577844995, -0.004593409719455879, -0.004535599860922524,
  -0.00445728570525301,  -0.004362469881297017,  -0.0042501708822830905,  -0.004120284706730435,
  -0.003974587693848104,  -0.003814901380318594,  -0.003642299368634417,  -0.0034570505575471544,
  -0.003260710678185438,  -0.003053434734731972,  -0.0028372697865244475,  -0.002613924611965202,
  -0.002383144481283403,  -0.002148350824063294, -0.0019075206217462758, -0.0016650052462718482,
  -0.0014179843735038604, -0.0011724081117273318, -0.0009241027030114334, -0.0006799799326299368,
  -0.00043522574411154036, -0.0001962915564054726, 0.00004062249781472064, 0.00027106553326555896,
  0.0004966264817311014,  0.000714972249800228,  0.0009259557442267539,  0.0011284868024924737,
  0.0013218224201994612,  0.0015053615156079877,  0.0016785915304533996,  0.001840528831557174,
  0.0019921823572090734,  0.0021301024448355946,  0.002258778305502216,  0.0023710336414560053,
  0.0024750537944191863,  0.0025610284211509274,  0.002638674822409953,  0.0026985294764617215,
  0.0027486098719066137,  0.0027823561500027834,  0.002804863087193834,  0.002812425317126703,
  0.002808663394508168,  0.0027898262676349177,  0.0027615963734293663,  0.0027161972830158643,
  0.0026654886119140994,  0.0025944563899648267,  0.0025223787595859983,  0.0024288131010452283,
  0.002335089392892868,  0.0022225119656553035,  0.0021080490705978018,  0.0019789962774483727,
  0.001847602777115003,  0.0017011945124342928,  0.0015589290893588147,  0.0013950622427804185,
  0.0012449045593625118,  0.0010700115388710902,  0.0009070527793806994,  0.0007297779862746035,
  0.0005604923947770094,  0.00036957543165597,  0.00020448681142760838,  0.000014787263331467169,
  -0.00015661183878642616,  -0.0003522980668294563,  -0.0005164948931739942,  -0.0007074045988542337,
  -0.0008647414805497481,  -0.0010546514579484422,  -0.0012050377048797441,  -0.001391736337876226,
  -0.0015305486297832371,  -0.0017101734853428782,  -0.001834077842198626,  -0.002005587866071696,
  -0.0021131413095489297,  -0.0022771047972569088, -0.0023669796819694596, -0.002522807512727684,
  -0.0025933837938034963,  -0.0027403381509319975,  -0.002789125473848081,  -0.002926934209610943,
  -0.002951853129932978,  -0.0030811510625117617,  -0.0030808430122533214,  -0.003202836154744756,
  -0.0031762025201501533,  -0.003292538143738589,  -0.003238225942722612,  -0.00335110057503356,
  -0.0032675257384755137,  -0.003379454244089983,  -0.0032648745486325422,  -0.0033784760357948836,
  -0.003231205720108523,  -0.0033498582596491917,  -0.0031678281969379192,  -0.0032958406688973615,
  -0.0030767528678586555,  -0.003218933912951922,  -0.002960247074711649, -0.0031220027697236217,
  -0.002820920769521245, -0.0030084681861656673, -0.0026612234198504794, -0.0028816592820257534,
  -0.0024834315778976125,  -0.002744794016059322,  -0.002290024978384548,  -0.002601053277664898,
  -0.0020833450535500194,  -0.0024537591210338624,  -0.0018650171818320094,  -0.0023064584555358572,
  -0.001637439035832092,  -0.002162631303529877, -0.0014021152433113494, -0.0020258369747564167,
  -0.0011605941656346712, -0.0018998108003590267, -0.000913935305670097, -0.0017877011074162047,
  -0.0006632119209307095, -0.0016935269804353057, -0.00040834948018148796, -0.0016203309422694644,
  -0.00498550729671324
    };
    static float32_t firStateF32[BLOCK_SIZE+FILTER_TAP_NUM-1];
    
   
    arm_fir_instance_f32 S;
    arm_status status;
    uint32_t numBlocks = LONGUEUR_ECH/BLOCK_SIZE;
    
    float32_t *inputF32;
    float32_t *outputF32;
    inputF32 = &Input[0];
    outputF32 = &Output[0];
    
    arm_fir_init_f32(&S, FILTER_TAP_NUM, (float32_t*)&filter_taps[0],&firStateF32[0],BLOCK_SIZE);
  
    for(i=0; i<numBlocks; i++)
    {
        arm_fir_f32(&S, inputF32+(i*BLOCK_SIZE),outputF32+(i*BLOCK_SIZE),BLOCK_SIZE);
    }
    i=1;
    
    // Calcul de la frequence cardiaque
    
    uint32_t vecteurMax[10];
    
    for (i=temps1; i<temps2; i++)
    {
        if (Output[i-1]<Output[i] && Output[i+1]<Output[i]){
         compteur++;
         vecteurMax[compteur]=Output[i];
        }
    }
    
    uint32_t BPM=compteur/(LONGUEUR_ECH/200)*60;
    
    return BPM;
    
}


// Cette fonction calcule la composante AC du signal. Elle prend en 
// parametre le signal rouge ou infrarouge et retourne la composante AC
uint32_t AC(uint32_t* Signal, uint32_t temps1, uint32_t temps2){
    
    // Filtrage du signal avec un filtre passe-haut
    float32_t Input[LONGUEUR_ECH];
    float32_t Output[LONGUEUR_ECH]; //initialiser le buffer output
    for (uint32_t i=temps1; i<temps2; i++){
     Input[i]=Signal[i];   
    }
    
    /*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 200 Hz

* 0 Hz - 1 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -27.834376542436516 dB

* 1.5 Hz - 100 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = 33.174551854408485 dB

*/

#define FILTER_TAP_NUM 5

static double filter_taps[FILTER_TAP_NUM] = {
  -0.47935126954373714,
  -0.0010642796926705778,
  0.9995153833515973,
  -0.0010642796926705778,
  -0.47935126954373714
};


    static float32_t firStateF32[BLOCK_SIZE+FILTER_TAP_NUM-1];
    
    uint32_t i;
    arm_fir_instance_f32 S;
    arm_status status;
    uint32_t numBlocks = LONGUEUR_ECH/BLOCK_SIZE;
    
    float32_t *inputF32;
    float32_t *outputF32;
    inputF32 = &Input[0];
    outputF32 = &Output[0];
    
    arm_fir_init_f32(&S, FILTER_TAP_NUM, (float32_t*)&filter_taps[0],&firStateF32[0],BLOCK_SIZE);
 
    for(i=0; i<numBlocks; i++)
    {
        arm_fir_f32(&S, inputF32+(i*BLOCK_SIZE),outputF32+(i*BLOCK_SIZE),BLOCK_SIZE);
    }
    i=1;
    
    // Calcul de la composante AC
    
    uint32_t compteur=0;
    uint32_t maximum, minimum, indexMax, indexMin, compoAC;
    uint32_t vecteur[temps2-temps1];
    
    for (i=temps1; i<temps2; i++){
     compteur++;
     vecteur[compteur]=Output[i];   
    }
    
    arm_max_f32(&vecteur,LONGUEUR_ECH,maximum,indexMax);
    arm_min_f32(&vecteur,LONGUEUR_ECH,minimum,indexMin);
    
    compoAC=maximum-minimum;
    
    return compoAC;
    
}
// Cette fonction calcule la composante AC du signal. Elle prend en 
// parametre le signal rouge ou infrarouge et retourne la composante DC
uint32_t DC(uint32_t *Signal, uint32_t temps1, uint32_t temps2){
    
    // Filtrage du signal avec un filtre passe-bas
    float32_t Input[LONGUEUR_ECH];
    float32_t Output[LONGUEUR_ECH]; //initialiser le buffer output
    for (uint32_t i=temps1; i<temps2; i++){
     Input[i]=Signal[i];   
    }
    
    /*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 200 Hz

* 0 Hz - 20 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = 4.175267724256128 dB

* 20.5 Hz - 100 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -40.00138087048454 dB

*/

#define FILTER_TAP_NUM 393

static double filter_taps[FILTER_TAP_NUM] = {
  0.004883602932705723, -0.0012212830742532454,-0.004043105802318912, -0.008343799321132715,
  -0.013404327388613775, -0.018208667174412725, -0.02163526472085718, -0.02273628944272536,
  -0.021014319485142006, -0.01660359191089071, -0.01028909873857956, -0.003340778444937561,
  0.0028022738572425054, 0.006910953656451442, 0.008297706736397546,  0.0069990575371054,
  0.0037493460679358754, -0.0002500499005094687, -0.003696038897509275, -0.005570590265010435,
  -0.005428833396853588,  -0.003499496562299646,  -0.0005696108496867208,  0.0023034596973952478,
  0.004153914460350156,  0.004422811938372284,  0.003124068661198564,  0.0008100798427267199,
  -0.0016449755881643106,  -0.003363782749281578,  -0.0037730411199179475,  -0.0027925921058277346,
  -0.0008435919094461764, 0.0013220213213486715,  0.0029047431942746346,  0.003348347755352851,
  0.0025333079895564665,  0.0008059067922094044,  -0.001162783783630514,  -0.002632646513681186,
  -0.003069454820989804,  -0.0023379313366500205,  -0.0007431158910805498,  0.0010928964891106774,
  0.002470602107032932,  0.002877982205295303,  0.002180402526601854,  0.0006644361672342459,
  -0.0010783695300414903,  -0.0023802847516195234,  -0.0027507173568886495,  -0.002059593478503381,
  -0.0005834602967865591, 0.0011025717886586355,  0.0023468182661148204,  0.0026728724634659776,
  0.001962956789852122,  0.0004995713484387185,  -0.0011486464294736534,  -0.0023462773143119262,
  -0.0026308591018263743,  -0.0018901665178607417,  -0.0004126109678649644,  0.0012214243262246701,
  0.0023770264343665136,  0.0026192141888523647,  0.0018271588939296735,  0.0003279340879905864,
  -0.0013091693392157534,  -0.0024418125378130266,  -0.002627011004513865,  -0.0017867010344551333,
  -0.00024171560402080436,  0.0014097765018735628,  0.0025239052362605124,  0.0026611793782167132,
  0.001759039383385775,  0.0001600830210954862,  -0.0015176310655477772,  -0.0026193525779095255,
  -0.002708626291835322,  -0.0017395781099246693,  -0.00007925089073637699,  0.001630901059787417,
  0.0027225405857329507,  0.0027611412832222668,  0.001718277331652988,  -0.000011947355255285637,
  -0.0017608337134148043,  -0.002842746343298086,  -0.002823507042392832,  -0.0016941632977048478,
  0.00011924015740337575,  0.001915785669284237,  0.0029896910199738564,  0.0029066312934632344,
  0.0016785038087734987,  -0.0002334062635061894,  -0.002091012948541357,  -0.003163462281697756,
  -0.0030137752374258496,  -0.0016760759692995481,  0.0003483755300619157,  0.0022786857086196564,
  0.0033552902703101375,  0.003138084001958525,  0.0016849794504999094,  -0.0004605339779834771,
  -0.002471594395648471,  -0.0035556730205532384,  -0.003266533997918725,  -0.0016875866499778324,
  0.0005889674901097257,  0.0026835849820632724,  0.0037683275642932047,  0.003392593024124353,
  0.001668504361247575,  -0.0007588416447842694,  -0.002950517899898767,  -0.004035696538165841,
  -0.003556908473036437,  -0.0016602070139867082,  0.0009477723348466241,  0.0032616916055680637,
  0.004362402120148302,  0.003781486813549685,  0.0017005063188724402,  -0.0011034494728261897,
  -0.0035491201351563364,  -0.004663169881940866,  -0.003962032805600016,  -0.0016736126798721578,
  0.0013558583587332826,  0.003949445896611179,  0.00507242696430862,  0.004230713945372826,
  0.0016901231480775545,  -0.001604832193926267,  -0.00438051137704791,  -0.005522969473971642,
  -0.004522441574898852,  -0.0016963630705801485,  0.001906157054912318,  0.0048907388411009965,
  0.006053286238319274,  0.00486162888592508, 0.0016923878290092188,  -0.0022810319182291383,
  -0.0055191121618126246,  -0.006708080952116486,  -0.005287291985011131,  -0.0017031553408138527,
  0.002722167106826413,  0.006273027031322032,  0.007499278748073254,  0.005800959622267597,
  0.0017062543460070424,  -0.003280752719267531,  -0.007224328176973803,  -0.008499562381749485,
  -0.006451237633383123,  -0.0017057293198226005,  0.004004680664889539,  0.008462364383475435,
  0.009811640834059535,  0.0073145279592928495,  0.0017136224062399012,  -0.004964697483484019,
  -0.010125412055009926,  -0.011591772892800651,  -0.008495990076379868,  -0.0017196918122866073,
  0.006319097089468581,  0.012497756243931837,  0.014163896537323573,  0.010224333297355575,
  0.001718734534667559,  -0.008387775643149216,  -0.016181126600413983,  -0.018238341367653912,
  -0.013025247156755538,  -0.001717481091418093,  0.011924632477033365,  0.022681457967738527,
  0.025689994446564703,  0.018360926221438936,  0.0017191876406038658,  -0.019366997522750864,
  -0.03726686621631573, -0.043742550783523605,  -0.032558088619251316,  -0.0017247480904783498,
  0.045366380740594056,  0.10036246047316046,  0.15188909023900304,  0.18849322011128417,
  0.20172706338934185,  0.18849322011128417,  0.15188909023900304,  0.10036246047316046,
  0.045366380740594056,  -0.0017247480904783498,  -0.032558088619251316,  -0.043742550783523605,
  -0.03726686621631573,  -0.019366997522750864,  0.0017191876406038658,  0.018360926221438936,
  0.025689994446564703, 0.022681457967738527, 0.011924632477033365,  -0.001717481091418093,
  -0.013025247156755538,  -0.018238341367653912,  -0.016181126600413983,  -0.008387775643149216,
  0.001718734534667559,  0.010224333297355575,  0.014163896537323573,  0.012497756243931837,
  0.006319097089468581,  -0.0017196918122866073,  -0.008495990076379868,  -0.011591772892800651,
  -0.010125412055009926,  -0.004964697483484019,  0.0017136224062399012,  0.0073145279592928495,
  0.009811640834059535,  0.008462364383475435,  0.004004680664889539,  -0.0017057293198226005,
  -0.006451237633383123,  -0.008499562381749485,  -0.007224328176973803,  -0.003280752719267531,
  0.0017062543460070424,  0.005800959622267597,  0.007499278748073254,  0.006273027031322032,
  0.002722167106826413,  -0.0017031553408138527,  -0.005287291985011131,  -0.006708080952116486,
  -0.0055191121618126246,  -0.0022810319182291383,  0.0016923878290092188,  0.00486162888592508,
  0.006053286238319274,  0.0048907388411009965,  0.001906157054912318,  -0.0016963630705801485,
  -0.004522441574898852,  -0.005522969473971642,  -0.00438051137704791,  -0.001604832193926267,
  0.0016901231480775545,  0.004230713945372826,  0.00507242696430862,  0.003949445896611179,
  0.0013558583587332826,  -0.0016736126798721578,  -0.003962032805600016,  -0.004663169881940866,
  -0.0035491201351563364,  -0.0011034494728261897,0.0017005063188724402,  0.003781486813549685,
  0.004362402120148302,  0.0032616916055680637,  0.0009477723348466241,  -0.0016602070139867082,
  -0.003556908473036437,  -0.004035696538165841,  -0.002950517899898767,  -0.0007588416447842694,
  0.001668504361247575,  0.003392593024124353,  0.0037683275642932047,  0.0026835849820632724,
  0.0005889674901097257,  -0.0016875866499778324,  -0.003266533997918725,  -0.0035556730205532384,
  -0.002471594395648471,  -0.0004605339779834771,  0.0016849794504999094,  0.003138084001958525,
  0.0033552902703101375,  0.0022786857086196564,  0.0003483755300619157,  -0.0016760759692995481,
  -0.0030137752374258496,
  -0.003163462281697756,  -0.002091012948541357,  -0.0002334062635061894,  0.0016785038087734987,
  0.0029066312934632344,  0.0029896910199738564,  0.001915785669284237,  0.00011924015740337575,
  -0.0016941632977048478,  -0.002823507042392832,  -0.002842746343298086,  -0.0017608337134148043,
  -0.000011947355255285637,  0.001718277331652988,  0.0027611412832222668,  0.0027225405857329507,
  0.001630901059787417,  -0.00007925089073637699,  -0.0017395781099246693,  -0.002708626291835322,
  -0.0026193525779095255,  -0.0015176310655477772,  0.0001600830210954862,  0.001759039383385775,
  0.0026611793782167132,  0.0025239052362605124,  0.0014097765018735628,  -0.00024171560402080436,
  -0.0017867010344551333,  -0.002627011004513865, -0.0024418125378130266, -0.0013091693392157534,
  0.0003279340879905864, 0.0018271588939296735,  0.0026192141888523647,  0.0023770264343665136,
  0.0012214243262246701,  -0.0004126109678649644,  -0.0018901665178607417,  -0.0026308591018263743,
  -0.0023462773143119262,  -0.0011486464294736534,  0.0004995713484387185,  0.001962956789852122,
  0.0026728724634659776,  0.0023468182661148204,  0.0011025717886586355,  -0.0005834602967865591,
  -0.002059593478503381,  -0.0027507173568886495, -0.0023802847516195234,  -0.0010783695300414903,
  0.0006644361672342459,  0.002180402526601854,  0.002877982205295303,  0.002470602107032932,
  0.0010928964891106774,  -0.0007431158910805498,  -0.0023379313366500205,  -0.003069454820989804,
  -0.002632646513681186,  -0.001162783783630514,  0.0008059067922094044,  0.0025333079895564665,
  0.003348347755352851,  0.0029047431942746346,  0.0013220213213486715,  -0.0008435919094461764,
  -0.0027925921058277346,  -0.0037730411199179475,  -0.003363782749281578,  -0.0016449755881643106,
  0.0008100798427267199,  0.003124068661198564,  0.004422811938372284,  0.004153914460350156,
  0.0023034596973952478,  -0.0005696108496867208,  -0.003499496562299646,  -0.005428833396853588,
  -0.005570590265010435,  -0.003696038897509275,  -0.0002500499005094687,  0.0037493460679358754,
  0.0069990575371054,  0.008297706736397546,  0.006910953656451442,  0.0028022738572425054,
  -0.003340778444937561,  -0.01028909873857956,  -0.01660359191089071,  -0.021014319485142006,
  -0.02273628944272536,  -0.02163526472085718,  -0.018208667174412725,  -0.013404327388613775,
  -0.008343799321132715,  -0.004043105802318912,  -0.0012212830742532454, 0.004883602932705723
};

    
    static float32_t firStateF32[BLOCK_SIZE+FILTER_TAP_NUM-1];
    
    uint32_t i;
    arm_fir_instance_f32 S;
    arm_status status;
    uint32_t numBlocks = LONGUEUR_ECH/BLOCK_SIZE;
    
    float32_t *inputF32;
    float32_t *outputF32;
    inputF32 = &Input[0];
    outputF32 = &Output[0];
    
    arm_fir_init_f32(&S, FILTER_TAP_NUM, (float32_t*)&filter_taps[0],&firStateF32[0],BLOCK_SIZE);
 
    for(i=0; i<numBlocks; i++)
    {
        arm_fir_f32(&S, inputF32+(i*BLOCK_SIZE),outputF32+(i*BLOCK_SIZE),BLOCK_SIZE);
    }
    i=1;
    
    
    // Calcul de la composante DC du signal
    uint32_t compteur=0;
    uint32_t compoDC;
    uint32_t vecteur[temps2-temps1];
    
    for (i=temps1; i<temps2; i++){
        compteur++;
        vecteur[compteur]=Output[i];
    }
    
    arm_mean_f32(&vecteur,LONGUEUR_ECH,compoDC);
    
    return compoDC;
    
}

// Cette fonction calcule la saturation sanguine en oxygene.
// Elle prend en parametres les signaux rouge et infrarouge et 
// retourne le SpO2 pour 5 secondes
uint32_t calculSpO2(uint32_t *InputRed, uint32_t *InputIR, uint32_t temps1, uint32_t temps2){
    
    // Coefficients de calibration
    double a=1.5958422;
    double b=-34.6596622;
    double c=118.7;
    
    uint32_t i;
    uint32_t AC660[SECONDES], DC660[SECONDES], AC880[SECONDES], DC880[SECONDES];
    
    for(i=temps1/BLOCK_SIZE; i<temps2/BLOCK_SIZE; i++){
        AC660[i]=AC(&InputRed,200*i, 200*i + 200);
        DC660[i]=DC(&InputRed,200*i, 200*i + 200);
        AC880[i]=AC(&InputIR,200*i, 200*i + 200);
        AC880[i]=DC(&InputIR,200*i, 200*i + 200);
    }
    
    uint32_t R;
    uint32_t mAC660, mDC660, mAC880, mDC880;
    
    arm_mean_f32(&AC660,sizeof(AC660),mAC660);
    arm_mean_f32(&DC660,sizeof(DC660),mDC660);
    arm_mean_f32(&AC880,sizeof(AC880),mAC880);
    arm_mean_f32(&DC880,sizeof(DC880),mDC880);
    
    R=(mAC660/mDC660)/(mAC880/mDC880);
    
    uint32_t SpO2=a*(R^2)+b*R+c;
    
    return SpO2;
}


/* [] END OF FILE */
